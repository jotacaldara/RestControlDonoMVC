@model RestControlMVC.DTOs.DashboardKpiDTO
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Localization
@using RestControlMVC
@inject Microsoft.Extensions.Localization.IStringLocalizer<AdminSharedResource> Localizer

<div class="row g-4">
    <div class="col-md-3">
        <div class="card-minimal p-4 border-0 shadow-sm" style="background: white; border-radius: 16px;">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="p-2 bg-primary-subtle rounded-3 text-primary">
                    <i class="bi bi-shop fs-4"></i>
                </div>
            </div>
            <h6 class="text-muted small fw-bold text-uppercase">@Localizer["Dashboard_TotalRestaurants"]</h6>
            <h2 class="fw-bold mb-0">@Model.TotalRestaurants</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-minimal p-4 border-0 shadow-sm" style="background: white; border-radius: 16px;">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="p-2 bg-success-subtle rounded-3 text-success">
                    <i class="bi bi-currency-dollar fs-4"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <p class="text-uppercase small fw-bold text-muted">@Localizer["Dashboard_PlatformRevenue"]</p>
                    <i class="bi bi-currency-dollar text-success fs-4"></i>
                </div>
                <h2 class="fw-bold">@Model.TotalRevenue.ToString("C2", new System.Globalization.CultureInfo("pt-PT"))</h2>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-minimal p-4 border-0 shadow-sm" style="background: white; border-radius: 16px;">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="p-2 bg-info-subtle rounded-3 text-info">
                    <i class="bi bi-calendar-check fs-4"></i>
                </div>
            </div>
            <h6 class="text-muted small fw-bold text-uppercase">@Localizer["Dashboard_TotalReservations"]</h6>
            <h2 class="fw-bold mb-0">@Model.TotalReservations</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-minimal p-4 border-0 shadow-sm" style="background: white; border-radius: 16px;">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="p-2 bg-warning-subtle rounded-3 text-warning">
                    <i class="bi bi-hourglass-split fs-4"></i>
                </div>
            </div>
            <h6 class="text-muted small fw-bold text-uppercase">@Localizer["Dashboard_PendingApprovals"]</h6>
            <h2 class="fw-bold mb-0 text-warning">@Model.PendingApprovals</h2>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-4">
            <h5 class="fw-bold mb-4">@Localizer["Dashboard_RevenueEvolution"]</h5>
            <canvas id="revenueChart" style="max-height: 350px;"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            try {
                const response = await fetch('/Admin/Dashboard/GetChartData');
                if (!response.ok) throw new Error("Erro ao buscar dados");
                const apiData = await response.json();
                const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const values = apiData.length === 12 ? apiData.map(d => d.total) : new Array(12).fill(0);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '@Localizer["Dashboard_CommissionLabel"]',
                            data: values,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#0d6efd'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#e9ecef' }, ticks: { callback: value => value + ' €' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            } catch (error) {
                console.error("Erro no gráfico:", error);
            }
        });
    </script>
</div>
